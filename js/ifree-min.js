IFree={};IFree.Util={createDelegate:function(a,b,e,d){var c=function(){var f;if(!e){f=arguments}else{if(d){f=IFree.Util.toArray(arguments).concat(e)}else{f=e}}a.apply(b,f)};return c},max:function(b,a){return b>a?b:a},min:function(b,a){return b<a?b:a},toArray:function(c){var a=[];for(var b=0;b<c.length;++b){a.push(c[b])}return a},foreach:function(d,a,c){if(!d){return}var b;for(b=0;b<d.length;b++){if(a.call(c,d[b],b)===false){return}}},mapToArray:function(c){if(!c){return}var b=[];var a;for(a in c){b.push(c[a])}return b},random:function(a){return Math.floor(Math.random()*(a+1))},swap:function(d,c,b){var a=d[c];d[c]=d[b];d[b]=a},arrayEmpty:function(b){for(var a=0;a<b.length;a++){if(b[a]){return false}}return true},sign:function(a){return a>0?1:a<0?-1:0},cat:function(a){return a.join(" ")},isArray:function(a){return $.isArray(a)},clone:function(a){return $.extend({},a)},indexOf:function(b,a){return $.inArray(a,b)},mod:function(d,c){return d-c*Math.floor(d/c)},smod:function(d,c){return d-c*Math.round(d/c)},angleDiff:function(d,c){return Math.abs(IFree.Util.smod(d-c,360))},makeIdSelector:function(a){return"#"+a},getElementSize:function(a){return{width:$(a).outerWidth(),height:$(a).outerHeight()}},offset:function(a){return IFree.Util.elementOffset(IFree.Util.getElement(a))},elementOffset:function(a){return a.offset()},elementPosition:function(a){return a.position()},setBackgroundImage:function(a,b){IFree.Util.setElementBackgroundImage($(IFree.Util.makeIdSelector(a)),b)},setElementBackgroundImage:function(a,b){a.css("background-image","url("+b+")")},setPosition:function(a,c,b){IFree.Util.setElementPosition($(IFree.Util.makeIdSelector(a)),c,b)},setSize:function(b,c,a){IFree.Util.setElementSize($(IFree.Util.makeIdSelector(b)),c,a)},setElementPosition:function(a,c,b){a.css({left:c+"px",top:b+"px"})},setElementOffset:function(a,c,b){a.offset({left:c,top:b})},setElementSize:function(b,c,a){b.width(c).height(a)},setElementHeight:function(b,a){b.height(a)},setElementWidth:function(a,b){a.width(b)},createElement:function(c,b,a){$(IFree.Util.makeIdSelector(c)).append($("<div>").attr({id:b,"class":a}))},setFontSize:function(a,b){IFree.Util.setElementFontSize(IFree.Util.getElement(a),b)},setElementFontSize:function(a,b){a.css({"font-size":b+"%"})},rotateElement:function(b,f){var d=CSS3Helpers.findTransformProperty(document.body);var e=IFree.Util.getElement(b)[0];var c="rotate("+f+"deg)";if(d=="filter"){var a=CSS3Helpers.getTransformationMatrix(c);CSS3Helpers.setMatrixFilter(e,a)}else{e.style[d]=c}},scaleX:function(a,b){IFree.Util.scale(a,b,"x")},scaleY:function(a,b){IFree.Util.scale(a,b,"y")},scale:function(a,c,b){var d=b.toLowerCase()=="x"?"fliph":"flipv";var f="scale"+b.toUpperCase()+"("+c+")";var e={"-moz-transform":f,"-webkit-transform":f,"-o-transform":f,transform:f,filter:d};if(IFree.Util.isIE9()){delete e.filter;e.msTransform=f}IFree.Util.getElement(a).css(e)},loadImage:function(a,b){$("<img />").load(function(){b()}).error(function(){alert("load of "+a+" failed!")}).attr("src",a)},windowWidth:function(){return IFree.Util.isMobileUser()?window.innerWidth:$(window).width()},windowHeight:function(){return IFree.Util.isMobileUser()?window.innerHeight:$(window).height()},onWindowResize:function(a){$(window).resize(a)},onClick:function(a,c){var b=IFree.Util.isSamsung()?"live":"bind";$(IFree.Util.makeIdSelector(a))[b]("click",function(d){c(d)})},getElement:function(a){return $(IFree.Util.makeIdSelector(a))},maxWidth:function(){return $.scrollTo.max($("body")[0],"x")},maxHeight:function(){return $.scrollTo.max($("body")[0],"y")},makeSelector:function(a){return"."+a},elementDefined:function(a){return a.length>0},scrollToElement:function(b){var a=0;var c=0;while(b!=null){a+=b.offsetLeft;c+=b.offsetTop;b=b.offsetParent}window.scrollTo(a,c)},onOrientationChange:function(a){window.onorientationchange=a},goToLink:function(a){window.location=a},isIE:function(){return !!$.browser.msie},isIE9:function(){return IFree.Util.isIE()&&Math.floor(parseFloat($.browser.version))>=9},isOpera:function(){return !!$.browser.opera},isWebkit:function(){return !!$.browser.webkit},isAndroid:function(){return IFree.Util.testUserAgents(["android"])},isSamsung:function(){return IFree.Util.testUserAgents(["samsung"])},isApple:function(){return IFree.Util.testUserAgents(["iphone","ipad"])},testUserAgents:function(b){var c=navigator.userAgent.toLowerCase();for(var a=0;a<b.length;a++){if(c.match(new RegExp(b[a]))){return true}}return false},isMobileUser:function(){return IFree.Util.testUserAgents(["android","iphone","ipad","samsung"])},getAbsolutePath:function(a){return IFree.Environment.getAbsolutePath(IFree.ImageRegistry.getItem(a).path())}};IFree.Task=Class.extend({_fnContexts:[],_events:{},_eventListeners:{},call:function(b,a,c){var d=arguments.length==1?b:IFree.Util.createDelegate(b[a],b,c,true);this._chainFnContext={onReady:d,after:[]};this._fnContexts.push(this._chainFnContext);return this},_checkReadyFn:function(b){var c=b.after;for(var a=0;a<c.length;a++){if(!this._events[c[a]]){return}}setTimeout(function(){b.onReady()})},after:function(){this._chainFnContext.after=[];for(var a=0;a<arguments.length;a++){this._eventListeners[arguments[a]]=this._eventListeners[arguments[a]]||[];this._eventListeners[arguments[a]].push(this._chainFnContext);this._chainFnContext.after.push(arguments[a])}return this},_checkReady:function(b){if(!this._eventListeners[b]){return}for(var a=0;a<this._eventListeners[b].length;a++){this._checkReadyFn(this._eventListeners[b][a])}},fire:function(a){var b=this._chainFnContext.onReady;this._chainFnContext.fire=a;this._chainFnContext.onReady=IFree.Util.createDelegate(function(c){b(IFree.Util.createDelegate(function(){this._events[c.fire]=true;this._checkReady(c.fire)},this))},this,[this._chainFnContext])},start:function(){IFree.Util.foreach(this._fnContexts,function(a){this._checkReadyFn(a)},this)}});IFree.TimerSingleton=Class.extend({_minimalInterval:0,_maximalInterval:0,_intervalCounter:0,init:function(){this._intervalFns=[];this._intervals=[];this._intervalsForDeletion=[]},registerFunction:function(b,a){if(!this._intervalFns[b]){this._intervals.push(b)}this._intervalFns[b]=this._intervalFns[b]||[];this._intervalFns[b].push(a);if(b<this._minimalInterval||this._minimalInterval==0){this._minimalInterval=b}if(b>this._maximalInterval){this._maximalInterval=b}this._tryRestart();return this._intervalFns[b].length},_tryRestart:function(){this.stopTimer();if(this._minimalInterval==0||this._maximalInterval==0){return}this.startTimer()},unregisterFunction:function(b,a){delete this._intervalFns[b][a-1];if(IFree.Util.arrayEmpty(this._intervalFns[b])){delete this._intervalFns[b];this._intervals.splice(IFree.Util.indexOf(this._intervals,b),1)}this._intervalsForDeletion.push(b)},_deleteIntervals:function(){IFree.Util.foreach(this._intervalsForDeletion,function(a){if(this._maximalInterval==0||this._minimalInterval==0){return false}if(a==this._maximalInterval){this._maximalInterval=0}if(a==this._minimalInterval){this._minimalInterval=0}},this);this._intervalsForDeletion=[];if(this._maximalInterval==0||this._minimalInterval==0){this._maximalInterval=this._findMaximumInterval();this._minimalInterval=this._findMinimumInterval();return true}return false},_findMaximumInterval:function(){return this._findInterval("max")},_findMinimumInterval:function(){return this._findInterval("min")},_findInterval:function(a){return this._intervals.length==0?0:Math[a].apply(Math,this._intervals)},_checkWaitFunctions:function(){var c=this._intervals.slice(0);var d=$.extend(true,[],this._intervalFns);var b;for(b=0;b<c.length;b++){var a=c[b];if(this._intervalCounter%a==0){this._executeWaitFunctions(d,a)}}},_executeWaitFunctions:function(b,a){var c=b[a];for(i=0;i<c.length;i++){if(c[i]){c[i]()}}},_timerFn:function(){var c=new Date().getTime();var a=Math.max(1,Math.floor((c-this._lastTime)/this._minimalInterval));this._lastTime+=a*this._minimalInterval;if(a>10){return}for(var b=0;b<a;b++){this._intervalCounter+=this._minimalInterval;this._checkWaitFunctions();if(this._intervalCounter==this._maximalInterval){this._intervalCounter=0;if(this._deleteIntervals()){this._tryRestart();return}}}},startTimer:function(){this._lastTime=new Date().getTime();this._intervalCounter=0;this._currentTimerId=setInterval(IFree.Util.createDelegate(this._timerFn,this),this._minimalInterval)},stopTimer:function(){clearInterval(this._currentTimerId)}});IFree.Timer=new IFree.TimerSingleton();IFree.ObjectFactory=Class.extend({init:function(a){this._objectConstructors=a.objectConstructors},create:function(a){return new this._objectConstructors[a.type](a)}});IFree.ItemRegistrySingleton=Class.extend({_items:null,_itemsUrl:null,_rootParentId:null,_defaultType:null,init:function(a){this._itemFactory=new IFree.ObjectFactory({objectConstructors:a.itemConstructors});this._itemsUrl=a.itemsUrl;this._rootParentId=a.rootParentId;this._defaultType=a.defaultType;this._defaultProperties=a.defaultProperties||{};this._items={}},loadItems:function(a){$.getJSON(this._itemsUrl,IFree.Util.createDelegate(function(b){this._createItems(b,this._rootParentId);if(a){a()}},this))},_assignDefaultProperties:function(b){for(var a in this._defaultProperties){b[a]=b[a]||this._defaultProperties[a]}},_createItems:function(a,b){IFree.Util.foreach(a,function(c){c.parentId=b;this._assignDefaultProperties(c);this._items[c.id]=this._itemFactory.create(c);this._createItems(c.children,c.id);if(this._items[c.id].onChildrenCreated){this._items[c.id].onChildrenCreated(c)}},this)},getItems:function(){return this._items},getItem:function(a){return this._items[a]},filterItems:function(b){var a=[];for(var c in this._items){if(b(this._items[c])===true){a.push(this._items[c])}}return a}});IFree.ScreenResolution=Class.extend({init:function(a){this._width=a.width;this._height=a.height;this._id=a.id},id:function(){return this._id},width:function(){return this._width},height:function(){return this._height}});IFree.ScreenResolutionRegistry=new IFree.ItemRegistrySingleton({itemsUrl:"resources/screenresolutions.json",itemConstructors:{resolution:IFree.ScreenResolution},defaultProperties:{type:"resolution"}});IFree.EnvironmentSingleton=Class.extend({_requiredWidth:600,_requiredHeight:614,_centerRegionWidth:1200,_centerRegionHeight:900,_currentResolution:{},init:function(a){this._screenWidth=a.screenWidth;this._screenHeight=a.screenHeight},_getScaleCoef:function(b,a){return IFree.Util.min(b/this._centerRegionWidth,a/this._centerRegionHeight)},_sortSupportedResolutionsByScreenCoef:function(){this._supportedResolutions=this._supportedResolutions.sort(function(b,a){return a.screenCoef-b.screenCoef})},_computeSupportedCoefs:function(){IFree.Util.foreach(this._supportedResolutions,function(a){a.screenCoef=this._getScaleCoef(a.width(),a.height())},this)},_chooseClosestSupportedResolution:function(b){var a=this._supportedResolutions[this._supportedResolutions.length-1];IFree.Util.foreach(this._supportedResolutions,function(c){if(b>=c.screenCoef){a=c;return false}});return a},chooseAppropriateScale:function(){this._supportedResolutions=IFree.Util.mapToArray(IFree.ScreenResolutionRegistry.getItems());this._computeSupportedCoefs();this._sortSupportedResolutionsByScreenCoef();var a=IFree.Util.min(this._screenWidth/this._requiredWidth,this._screenHeight/this._requiredHeight);this._currentResolution=this._chooseClosestSupportedResolution(a)},getAbsolutePath:function(a){return"/images/"+this._currentResolution.id()+"/"+a+"?"},xFromScreenToRelative:function(a){return a/this._currentResolution.screenCoef},yFromScreenToRelative:function(a){return a/this._currentResolution.screenCoef},xFromRelativeToScreen:function(a){return a*this._currentResolution.screenCoef},yFromRelativeToScreen:function(a){return a*this._currentResolution.screenCoef},screenFontSize:function(a){return a*this._currentResolution.screenCoef},centerRegionSize:function(){return{width:this._centerRegionWidth,height:this._centerRegionHeight}}});IFree.Environment=new IFree.EnvironmentSingleton({screenWidth:IFree.Util.windowWidth(),screenHeight:IFree.Util.windowHeight()});IFree.XYHelperSingleton=Class.extend({setSize:function(b,c,a){this.setElementSize(IFree.Util.getElement(b),c,a)},setPosition:function(a,c,b){this.setElementPosition(IFree.Util.getElement(a),c,b)},setOffset:function(a,c,b){this.setElementOffset(IFree.Util.getElement(a),c,b)},setElementSize:function(b,c,a){this.setElementWidth(b,c);this.setElementHeight(b,a)},setElementHeight:function(c,a){var b=IFree.Environment.yFromRelativeToScreen(a);IFree.Util.setElementHeight(c,b)},setElementWidth:function(a,c){var b=IFree.Environment.xFromRelativeToScreen(c);IFree.Util.setElementWidth(a,b)},setElementPosition:function(b,e,d){var c=IFree.Environment.xFromRelativeToScreen(e);var a=IFree.Environment.yFromRelativeToScreen(d);IFree.Util.setElementPosition(b,c,a)},setElementOffset:function(b,e,d){var c=IFree.Environment.xFromRelativeToScreen(e);var a=IFree.Environment.yFromRelativeToScreen(d);IFree.Util.setElementOffset(b,c,a)},getSize:function(a){return this.getElementSize(IFree.Util.getElement(a))},getPosition:function(a){return this.getElementPosition(IFree.Util.getElement(a))},getOffset:function(a){return this.getElementOffset(IFree.Util.getElement(a))},getElementSize:function(a){var b=IFree.Util.getElementSize(a);return{width:IFree.Environment.xFromScreenToRelative(b.width),height:IFree.Environment.yFromScreenToRelative(b.height)}},getElementPosition:function(a){var b=IFree.Util.elementPosition(a);return{left:IFree.Environment.xFromScreenToRelative(b.left),top:IFree.Environment.yFromScreenToRelative(b.top)}},getElementOffset:function(a){var b=IFree.Util.elementOffset(a);return{left:IFree.Environment.xFromScreenToRelative(b.left),top:IFree.Environment.yFromScreenToRelative(b.top)}},getEventOffsets:function(c,a){if(!a){return{offsetX:IFree.Environment.xFromScreenToRelative(c.offsetX),offsetY:IFree.Environment.yFromScreenToRelative(c.offsetY)}}else{var b=IFree.Util.getElement(a).offset();return{offsetX:IFree.Environment.xFromScreenToRelative(c.pageX-b.left),offsetY:IFree.Environment.yFromScreenToRelative(c.pageY-b.top)}}}});IFree.XYHelper=new IFree.XYHelperSingleton();IFree.Image=Class.extend({_path:null,_id:null,_type:null,init:function(a){this._path=a.path||"photos/empty/empty";this._id=a.id;this._type=a.type;this._format=a.format;this._group=a.group},group:function(){return this._group},type:function(){return this._type},path:function(){return this._path+"."+this._format}});IFree.AnimatedImage=IFree.Image.extend({_frameCount:null,init:function(a){this._super(a);this._frameCount=a.frameCount;this._frameCounter=0},length:function(){return this._frameCount},_getFrame:function(){return this._path+"-"+this._frameCounter+"."+this._format},nextFrame:function(){if(this._frameCounter==this._frameCount){this._frameCounter=0}var a=this._getFrame();this._frameCounter++;return a},ended:function(){return(this._frameCounter==this._frameCount)},reset:function(){this._frameCounter=0;return this.nextFrame()}});IFree.Image.Type={STATIC:"static",ANIMATED:"animated"};IFree.ImageRegistry=new IFree.ItemRegistrySingleton({itemsUrl:"resources/images.json",itemConstructors:{"static":IFree.Image,animated:IFree.AnimatedImage},defaultProperties:{group:"second",type:"static"}});IFree.ImageLoaderSingleton=Class.extend({loadImageContent:function(a,c){var b={loadCount:0,loadCounter:0,afterLoadCallback:c,imagePathes:a};this._makeAbsolutePathes(b);this._startLoadImages(b)},_makeAbsolutePathes:function(a){IFree.Util.foreach(a.imagePathes,function(b,c){a.imagePathes[c]=IFree.Environment.getAbsolutePath(b)},this)},_onImageLoaded:function(a){a.loadCounter++;if(a.loadCounter==a.loadCount&&a.afterLoadCallback){a.afterLoadCallback()}},_startLoadImage:function(a,b){IFree.Util.loadImage(a,IFree.Util.createDelegate(this._onImageLoaded,this,[b]))},_startLoadImages:function(a){a.loadCount=a.imagePathes.length;IFree.Util.foreach(a.imagePathes,function(b){this._startLoadImage(b,a)},this)}});IFree.ImageLoader=new IFree.ImageLoaderSingleton();IFree.ImageLoadControllerSingleton=Class.extend({_getStationInputAnimations:function(){var b=[];var a=IFree.ObjectRegistry.filterItems(function(c){return c.type()==IFree.Object.Type.STATION_INPUT});IFree.Util.foreach(a,function(c){b=b.concat(this._getAnimationRemainFrames(c))},this);return b},loadStationInputs:function(a){var b=this._getStationInputAnimations();IFree.ImageLoader.loadImageContent(b,a)},_getFirstFramesFromAnimations:function(){var b=IFree.ImageRegistry.filterItems(function(c){return c.type()==IFree.Image.Type.ANIMATED});var a=[];IFree.Util.foreach(b,function(c){a.push(c.reset())},this);return a},_getAnimationRemainFrames:function(b){var c=b.image();var a=[];c.reset();while(!c.ended()){a.push(c.nextFrame())}c.reset();return a},loadAnimationRemainFrames:function(c,a){var b=this._getAnimationRemainFrames(c);IFree.ImageLoader.loadImageContent(b,a)},loadAnimationFirstFrames:function(b){var a=this._getFirstFramesFromAnimations();IFree.ImageLoader.loadImageContent(a,b)},loadImageGroup:function(b,d){var a=IFree.ImageRegistry.filterItems(function(e){return e.group()==d});var c=[];IFree.Util.foreach(a,function(e){c.push(e.path())},this);IFree.ImageLoader.loadImageContent(c,b)}});IFree.ImageLoadController=new IFree.ImageLoadControllerSingleton();var _worldObjectClass="ifree-world-object";IFree.Object=Class.extend({_id:null,_coordinates:null,_size:null,_type:null,_parentId:null,init:function(a,b){this._id=a.id;this._coordinates=a.coordinates.slice(0);this._size=a.size.slice(0);this._type=a.type;this._parentId=a.parentId;this._image=IFree.ImageRegistry.getItem(a.imageId);IFree.Util.createElement(this._parentId,this._id,_worldObjectClass);this._setPosition();this._setSize()},_setBackgroundImage:function(b){var a=IFree.Environment.getAbsolutePath(b);IFree.Util.setBackgroundImage(this._id,a)},_setSize:function(){var b=IFree.Environment.xFromRelativeToScreen(this._size[0]);var a=IFree.Environment.yFromRelativeToScreen(this._size[1]);IFree.Util.setSize(this._id,b,a)},_setPosition:function(){var b=IFree.Environment.xFromRelativeToScreen(this._coordinates[0]);var a=IFree.Environment.yFromRelativeToScreen(this._coordinates[1]);IFree.Util.setPosition(this._id,b,a)},id:function(){return this._id},imageId:function(){return this._imageId},coordinates:function(){return this._coordinates},type:function(){return this._type},width:function(){return this._size[0]},height:function(){return this._size[1]},setSize:function(b,a){this._size=[b,a];this._setSize()},setPosition:function(a,b){this._coordinates=[a,b];this._setPosition()},image:function(){return this._image}});IFree.Object.Type={ANIMATED:"animated",STATIC:"static",STATION_INPUT:"station-input"};IFree.StaticObject=IFree.Object.extend({init:function(a){this._super(a);this._setBackgroundImage(this._image.path())}});IFree.AnimatedObject=IFree.Object.extend({_animationInterval:null,init:function(a){this._super(a);this._animationInterval=a.animationInterval;this._setBackgroundImage(this._image.reset())},_startAnimation:function(a){if(this._currentTimerId){return}this._currentTimerId=IFree.Timer.registerFunction(this._animationInterval,IFree.Util.createDelegate(a,this))},_animationFn:function(){this._setBackgroundImage(this._image.nextFrame())},_stopAnimation:function(){if(this._currentTimerId){IFree.Timer.unregisterFunction(this._animationInterval,this._currentTimerId);this._setBackgroundImage(this._image.reset());delete this._currentTimerId}},play:function(){this._startAnimation(this._animationFn)},_animationStep:function(){this._setBackgroundImage(this._image.nextFrame())},_animationOnceFn:function(){if(this._image.ended()){this._animationStep();this._stopAnimation();this._endPlayOnce()}else{this._animationStep()}},playOnce:function(a){if(this._onPlayEnded){return}this._onPlayEnded=a;this._startAnimation(this._animationOnceFn)},_endPlayOnce:function(){if(this._onPlayEnded){this._onPlayEnded();delete this._onPlayEnded}},stop:function(){this._stopAnimation();this._endPlayOnce()}});IFree.Station=IFree.Object.extend({_stationAnimation:null,init:function(a){this._super(a);this._stationAngle=a.stationAngle},receivePassengers:function(a){if(!this._stationAnimation){return}this._stationAnimation.playOnce(a)},close:function(){this._stationAnimation.stop()},getStationAngle:function(){return this._stationAngle},onChildrenCreated:function(){this._stationAnimation=IFree.ObjectRegistry.getItem(this._id+"-input")}});IFree.Train=IFree.StaticObject.extend({init:function(a){this._angleStep=a.angleStep;this._trainMotionDelay=a.trainMotionDelay;this._currentAngle=0;this._targetAngle=this._currentAngle;this._super(a);this._startMotion()},_startMotion:function(){IFree.Timer.registerFunction(this._trainMotionDelay,IFree.Util.createDelegate(this._trainMotion,this))},_trainMotion:function(a){if(this._currentAngle==this._targetAngle){return}this._currentAngle+=this._angleStep;IFree.Util.rotateElement(this._id,this._currentAngle);if(this._currentAngle==360){this._currentAngle=0}if(this._currentAngle==this._targetAngle&&this._targetAngleCallback){this._targetAngleCallback()}},goTo:function(a,b){this._targetAngle=a.getStationAngle();this._targetAngleCallback=b},currentAngle:function(){return this._currentAngle}});var _topLevelElementId="ifree-body";IFree.ObjectRegistry=new IFree.ItemRegistrySingleton({rootParentId:_topLevelElementId,itemsUrl:"resources/objects.json",itemConstructors:{"static":IFree.StaticObject,animated:IFree.AnimatedObject,"station-input":IFree.AnimatedObject,station:IFree.Station,train:IFree.Train,object:IFree.Object}});IFree.TrainRouter=Class.extend({_train:null,init:function(a){this._train=a.train;this._stations=[]},addStation:function(a){this._stations.push(a)},start:function(){this._destinationStationNumber=0;this._goToStation()},_getDestinationStation:function(){return this._stations[this._destinationStationNumber]},setNextStation:function(a){if(a==this._getDestinationStation()){return}this._getDestinationStation().close();this._selectStation(a);this._goToStation()},_selectStation:function(a){this._destinationStationNumber=IFree.Util.indexOf(this._stations,a)},_selectNextStation:function(){this._destinationStationNumber++;if(this._destinationStationNumber==this._stations.length){this._destinationStationNumber=0}},_goToStation:function(){this._train.goTo(this._getDestinationStation(),IFree.Util.createDelegate(this._onStationArrived,this))},_onStationArrived:function(){this._getDestinationStation().receivePassengers(IFree.Util.createDelegate(function(){this._selectNextStation();this._goToStation()},this))}});IFree.TrainControllerSingleton=Class.extend({_trainClickElementId:"ifree-train-click-element",_clickableClass:"ifree-clickable-object",_trainElementId:"ifree-world-train",_trainWidth:30,_trainRoadWidth:305,_trainStartAngle:38,createClickElement:function(a){IFree.Util.createElement("ifree-body",this._trainClickElementId,this._clickableClass);if(a){a()}},start:function(){if(!IFree.Util.getElement(this._trainClickElementId)){this.createClickELement()}this._startListenMouse();this._startTrainMotion()},_startListenMouse:function(){this._onClick(IFree.Util.createDelegate(function(a){IFree.Util.getElement(this._trainClickElementId).click()},this));this._onOver(IFree.Util.createDelegate(function(a){$(IFree.Util.makeIdSelector(this._trainClickElementId)).offset({left:a.pageX,top:a.pageY});IFree.Util.getElement(this._trainClickElementId).mouseenter();IFree.Util.getElement("ifree-earth-container").addClass(this._clickableClass)},this),IFree.Util.createDelegate(function(){IFree.Util.getElement(this._trainClickElementId).mouseleave();IFree.Util.getElement("ifree-earth-container").removeClass(this._clickableClass)},this))},_startTrainMotion:function(){var b=new IFree.TrainRouter({train:IFree.ObjectRegistry.getItem(this._trainElementId)});var a=["ifree-station-products","ifree-station-b2b","ifree-station-development"];IFree.Util.foreach(a,function(d){var c=IFree.ObjectRegistry.getItem(d);b.addStation(c);IFree.Util.getElement(d).mouseenter(function(){b.setNextStation(c)})},this);b.start()},_isTrainBodyAt:function(l,k){var n=this._trainRoadWidth/2;var d=n+98;var c=n+104;var j=-(l-d);var g=-(k-c);function m(a,o){return Math.sqrt(a*a+o*o)}var b=m(j,g);var f=IFree.ObjectRegistry.getItem(this._trainElementId);var e=f.currentAngle()-(360-this._trainStartAngle);var h=Math.atan2(g,j)*180/Math.PI;if(b>n-this._trainWidth&&b<n&&IFree.Util.angleDiff(h,e)<62.5){return true}return false},_onEvent:function(b,c,a){IFree.Util.getElement("ifree-earth-container").live(b,IFree.Util.createDelegate(function(e){if(e.target.id!=this._trainElementId&&e.target.id!="ifree-earth-container"){if(a){a(e)}return}var d=IFree.XYHelper.getEventOffsets(e,"ifree-earth-container");if(this._isTrainBodyAt(d.offsetX,d.offsetY)){c(e)}else{if(a){a(e)}}},this))},_onClick:function(a){this._onEvent("click",a)},_onOver:function(b,c){var a=false;this._onEvent("mousemove",function(d){if(!a){b(d);a=true}},function(d){if(a){c();a=false}});IFree.Util.getElement("ifree-earth-container").mouseout(IFree.Util.createDelegate(function(d){if(a){c();a=false}},this))},getTrainPosition:function(a){var f=a||0;var h=IFree.XYHelper.getOffset("ifree-train-road");var j=this._trainRoadWidth/2;var e=j+h.left;var d=j+h.top;var g=IFree.ObjectRegistry.getItem(this._trainElementId).currentAngle()+this._trainStartAngle;var c=(j-this._trainWidth/2)*Math.cos((g+f)*Math.PI/180);var b=(j-this._trainWidth/2)*Math.sin((g+f)*Math.PI/180);return{left:-c+e,top:-b+d}},trainVisible:function(){var a=IFree.ObjectRegistry.getItem(this._trainElementId).currentAngle();return a>75&&a<330},trainAngle:function(){return IFree.ObjectRegistry.getItem(this._trainElementId).currentAngle()+this._trainStartAngle}});IFree.TrainController=new IFree.TrainControllerSingleton();IFree.UniverseLocationControllerSingleton=Class.extend({_scrollDelay:IFree.Util.isMobileUser()?10:200,_setRegionsLocation:function(d,a){var j,f,k;var l=3;var e=IFree.Environment.centerRegionSize();if(a<e.height){j=0;f=0;k=a}else{var c=a-e.height;j=c/2;f=c-j+l;k=e.height}var h=IFree.ObjectRegistry.getItem("ifree-top-region");var b=IFree.ObjectRegistry.getItem("ifree-center-region");var g=IFree.ObjectRegistry.getItem("ifree-bottom-region");h.setSize(d,j);b.setSize(d,k);g.setSize(d,f);h.setPosition(0,0);b.setPosition(0,j);g.setPosition(0,j+k-l)},_center:function(b,a){return a>b?0:(b-a)/2},_setSunSystemLocation:function(b,a){var c=IFree.ObjectRegistry.getItem("ifree-solar-system");var e,d;e=this._center(b,c.width());d=this._center(a,c.height());c.setPosition(e,d)},_setStarsLocation:function(c,b){var a=IFree.ObjectRegistry.getItem("ifree-stars");var d=IFree.ObjectRegistry.getItem("ifree-solar-system");var f=d.coordinates()[1]+d.height()-200;var e=b-f;a.setSize(c,e);a.setPosition(0,f)},_setSunMoonLocation:function(d,b){var c=IFree.ObjectRegistry.getItem("ifree-sun");c.setPosition(d-c.width(),0);var a=IFree.ObjectRegistry.getItem("ifree-moon");a.setPosition(0,b-a.height())},adjustLocation:function(a){this._locateElements();setTimeout(IFree.Util.createDelegate(this._scrollToCenter,this));this._updateCurrentWindowSize();if(a){a()}},_locateElements:function(){IFree.Util.getElement("ifree-body").addClass("ifree-no-scroll");var e=IFree.Environment.xFromScreenToRelative(IFree.Util.windowWidth());var c=IFree.Environment.yFromScreenToRelative(IFree.Util.windowHeight());IFree.Util.getElement("ifree-body").removeClass("ifree-no-scroll");var d=IFree.ObjectRegistry.getItem("ifree-solar-system");if(!d){return}var b=IFree.Util.max(e,d.width());var a=IFree.Util.max(c,d.height());this._setRegionsLocation(b,a);this._setSunSystemLocation(b,a);this._setStarsLocation(b,a);this._setSunMoonLocation(b,a);this._locateAnchor()},getSizeAbsolute:function(){var a=IFree.Util.getElement("ifree-solar-system");return{width:Math.max(IFree.Util.windowWidth(),a.width()),height:Math.max(IFree.Util.windowHeight(),a.height())}},_androidTrickyCheckSayReturn:function(){if(this._currentOrientation==window.orientation){if(this._counter<1){this._counter++}else{return true}}else{this._currentOrientation=window.orientation;this._counter=0}},_windowSizeChanged:function(){var b=this._currentWindowSize.width!=IFree.Util.windowWidth();var a=this._currentWindowSize.height!=IFree.Util.windowHeight();return b||a},_updateCurrentWindowSize:function(){this._currentWindowSize={width:IFree.Util.windowWidth(),height:IFree.Util.windowHeight()}},_onWindowResize:function(){if(IFree.Util.isAndroid()&&this._androidTrickyCheckSayReturn()){return}if(this._windowSizeChanged()){this._locateElements();this._scrollToCenter();this._updateCurrentWindowSize()}},_locateAnchor:function(){var d=IFree.Util.getElement("ifree-solar-system");var f={width:d.width(),height:d.height()};var c={width:IFree.Util.windowWidth(),height:IFree.Util.windowHeight()};var a=Math.max((f.width-c.width)/2,0);var e=Math.max((f.height-c.height)/2,0);var b=Math.min(f.width,c.width);IFree.Util.getElement("ifree-scroll-anchor").width(b);IFree.Util.setPosition("ifree-scroll-anchor",a,e)},_scrollToAnchor:function(){IFree.Util.scrollToElement(IFree.Util.getElement("ifree-scroll-anchor")[0])},_scrollToCenter:function(){this._scrollToAnchor();if(IFree.Util.isMobileUser()){this._locateElements();this._scrollToAnchor()}},_initDataForAndroidTricks:function(){this._counter=0;this._currentOrientation=1},init:function(){if(IFree.Util.isApple()){IFree.Util.onOrientationChange(IFree.Util.createDelegate(this._onWindowResize,this))}else{IFree.Util.onWindowResize(IFree.Util.createDelegate(this._onWindowResize,this))}this._updateCurrentWindowSize();this._initDataForAndroidTricks()}});IFree.UniverseLocationController=new IFree.UniverseLocationControllerSingleton();IFree.RandomPlayer=Class.extend({start:function(){this._playObjects=this._createPlayObjectList();this._playList=this._generateRandomList(this._playObjects.length);this._currentIndex=-1},_generateRandomList:function(c){var b=[];for(var a=0;a<c;a++){b.push(a)}for(var a=0;a<c;a++){IFree.Util.swap(b,IFree.Util.random(c-1),a)}return b},_createPlayObjectList:function(){return[]},_getPlayObjectList:function(){return this._playObjects},_getCurrentPlayObject:function(){return this._getPlayObject(this._currentIndex)},_getPlayObject:function(a){return this._playObjects[this._playList[a]]},_objectReady:function(a){return true},_getNextReadyPlayObject:function(){while(true){this._incrementPlayPosition();var a=this._getCurrentPlayObject();if(this._objectReady(a)){return a}}},_incrementPlayPosition:function(){this._currentIndex=(this._currentIndex+1)%this._playObjects.length},_playObject:function(a){},_playNext:function(){var a=this._getNextReadyPlayObject();this._playObject(a)}});IFree.AnimationControllerSingleton=IFree.RandomPlayer.extend({start:function(){this._super();this._initHoverBehaviour();this._startLoadAnimations()},_startLoadAnimations:function(){var a=this._getPlayObject(0);IFree.ImageLoadController.loadAnimationRemainFrames(a,IFree.Util.createDelegate(function(b){this._markAsLoaded(b);this._playNext()},this,[a]));IFree.Util.foreach(this._playList.slice(1),function(b){var c=this._getPlayObject(b);IFree.ImageLoadController.loadAnimationRemainFrames(c,IFree.Util.createDelegate(this._markAsLoaded,this,[c]))},this)},_markAsLoaded:function(a){a.loaded=true},_loaded:function(a){return a.loaded},_initHoverBehaviour:function(){if(IFree.Util.isMobileUser()){return}IFree.Util.foreach(this._getPlayObjectList(),function(a){IFree.Util.getElement(a.id()).hover(IFree.Util.createDelegate(function(){if(!this._loaded(a)){return}a.play()},this),IFree.Util.createDelegate(function(){a.stop()},this))},this)},_createPlayObjectList:function(){var c=IFree.ObjectRegistry.getItems();var b=[];for(var a in c){if(c[a].type()==IFree.Object.Type.ANIMATED){b.push(c[a])}}return b},_objectReady:function(a){return this._loaded(a)},_playObject:function(a){a.playOnce(IFree.Util.createDelegate(this._playNext,this))}});IFree.AnimationController=new IFree.AnimationControllerSingleton();IFree.ClickMeControllerSingleton=IFree.RandomPlayer.extend({_trainClickElementId:"ifree-train-click-element",_trainElementId:"ifree-world-train",_popupShowInterval:2000,_popupDelay:2000,hide:function(){IFree.ClickMePopup.hide()},_getObjectPosition:function(a){return a.objectId==this._trainClickElementId?IFree.TrainController.getTrainPosition():IFree.XYHelper.getOffset(a.objectId)},_getTargetSide:function(a){if(a.objectId!=this._trainClickElementId){return a.targetSide}var b=IFree.TrainController.trainAngle();return b>180?"left top":"right top"},showForObject:function(a){var d=this._getObjectPosition(a);var b=IFree.ObjectRegistry.getItem(a.objectId);var c=this._getTargetSide(a);IFree.ClickMePopup.showAt(d.left,d.top,b.width(),b.height(),c,a.offsetLeft,a.offsetTop)},start:function(){this._super();this._playNext()},_createPlayObjectList:function(){var c=IFree.Popup.ClickableObjectRegistry.getItems();var b=[];for(var a in c){b.push(c[a])}return b},_objectReady:function(a){return a.config().objectId==this._trainClickElementId?IFree.TrainController.trainVisible():true},_playObject:function(a){this.showForObject(a.config());setTimeout(IFree.Util.createDelegate(function(){this.hide();setTimeout(IFree.Util.createDelegate(this._playNext,this),this._popupDelay)},this),this._popupShowInterval)}});IFree.ClickMeController=new IFree.ClickMeControllerSingleton();IFree.FontLoaderSingleton=Class.extend({init:function(a){this._fonts=a.fonts;this._fontCounter=this._fonts.length},_checkLoaded:function(a){this._fontCounter--;if(this._fontCounter==0&&a){a()}},load:function(a){WebFont.load({custom:{families:this._fonts},fontactive:IFree.Util.createDelegate(this._checkLoaded,this,[a]),fontinactive:IFree.Util.createDelegate(this._checkLoaded,this,[a])})}});IFree.FontLoader=new IFree.FontLoaderSingleton({fonts:["SegoePrint","Calibri"]});IFree.ClickMePopupSingleton=Class.extend({_popupOffset:null,_showPopupClass:"ifree-popup-show",_popupBackgroundId:"ifree-popupbox-background",_popupTextId:"ifree-popupbox-text",_popupId:"ifree-popup-box",_popupWidth:109,_popupHeight:27,_text:"Click me",_getSides:function(){return["right","left","top","bottom"]},_getDefaultTargetSide:function(){return"left bottom"},_parseTargetSideString:function(a){var b={};IFree.Util.foreach(this._getSides(),function(c){b[c]=a.indexOf(c)!=-1});return b},_getTargetOffset:function(b,a){var c=IFree.XYHelper.getSize(this._popupId);var d={left:0,top:0};if(this._popupTargetSide.right){d.left=b}if(this._popupTargetSide.left){d.left=-c.width}if(this._popupTargetSide.top){d.top=-c.height}if(this._popupTargetSide.bottom){d.top=a}return d},_getTargetImagePostfix:function(){var a="";IFree.Util.foreach(this._getSides(),function(b){if(this._popupTargetSide[b]){a+=b.substring(0,1)}},this);return a},_getBackgroundImageId:function(){return"popup-clickme-"+this._getTargetImagePostfix()},_locatePopup:function(b,g,c,a,e,d){var f=this._getTargetOffset(c,a);IFree.XYHelper.setOffset(this._popupId,b+f.left+e,g+f.top+d)},_createPopupBody:function(){IFree.Util.createElement("ifree-body",this._popupId);IFree.XYHelper.setSize(this._popupId,this._popupWidth,this._popupHeight)},_createPopupBackground:function(){IFree.Util.createElement(this._popupId,this._popupBackgroundId,"ifree-popup-box-component");IFree.XYHelper.setSize(this._popupBackgroundId,this._popupWidth,this._popupHeight);IFree.Util.setBackgroundImage(this._popupBackgroundId,IFree.Util.getAbsolutePath(this._getBackgroundImageId()));IFree.XYHelper.setPosition(this._popupBackgroundId,0,0)},_createPopupText:function(){IFree.Util.createElement(this._popupId,this._popupTextId,"ifree-caption-text ifree-popup-box-component");IFree.Util.getElement(this._popupTextId).text(this._text);IFree.Util.setFontSize(this._popupTextId,IFree.Environment.screenFontSize(90));IFree.XYHelper.setPosition(this._popupTextId,19,1)},_createPopup:function(){this._createPopupBody();this._createPopupBackground();this._createPopupText()},_showPopup:function(){IFree.Util.getElement(this._popupId).addClass(this._showPopupClass)},_parsePopupTargetSide:function(a){this._popupTargetSide=this._parseTargetSideString(a||this._getDefaultTargetSide())},showAt:function(c,g,d,b,a,f,e){this._parsePopupTargetSide(a);this._createPopup();this._locatePopup(c,g,d,b,f||0,e||0);this._showPopup()},hide:function(){IFree.Util.getElement(this._popupId).remove()}});IFree.ClickMePopup=new IFree.ClickMePopupSingleton();IFree.Popup={};IFree.Observable=Class.extend({init:function(a){this._events={}},addEvent:function(a){this._events[a]=[]},fireEvent:function(a,b){if(!this._events[a]){return}IFree.Util.foreach(this._events[a],function(c){c(b)})},on:function(a,b){if(!this._events[a]){return}this._events[a].push(b)}});IFree.Popup.Component=IFree.Observable.extend({_setElementSize:function(b,c,a){IFree.XYHelper.setElementSize(b,c,a)},_setElementPosition:function(a,c,b){IFree.XYHelper.setElementPosition(a,c,b)},_setPosition:function(a,c,b){IFree.XYHelper.setPosition(a,c,b)},_setSize:function(b,c,a){IFree.XYHelper.setSize(b,c,a)},_setElementWidth:function(a,b){IFree.XYHelper.setElementWidth(a,b)}});IFree.Popup.Window=IFree.Popup.Component.extend({_windowTemplate:"<div id='${id}' class='ifree-popup-window'><div class='ifree-popup-left ifree-popup-component'></div><div class='ifree-popup-center ifree-popup-component'></div><div class='ifree-popup-right ifree-popup-component'></div></div>",_popupWindowId:"ifree-window-popup",_popupMaskId:"ifree-popup-mask",_bodyId:"ifree-body",init:function(a){this._super(a);this._position=IFree.Util.clone(a.position)},_createMask:function(){IFree.Util.createElement(this._bodyId,this._popupMaskId)},_destroyMask:function(){IFree.Util.getElement(this._popupMaskId).remove()},showScreen:function(a){this._createMask();this._updateMaskLocation();this._currentScreen=a;$.template("window-template",this._windowTemplate);this._windowMarkup=$.tmpl("window-template",{id:this._popupWindowId});this._windowMarkup.appendTo($(IFree.Util.makeIdSelector(this._bodyId)));this._changeScreen(a);if(IFree.Util.isWebkit()){this._setWebkitLocation()}else{this._setLocation()}IFree.Util.getElement(this._popupMaskId).click(IFree.Util.createDelegate(function(){this._onClose()},this))},_changeScreen:function(a){if(IFree.Util.isWebkit()){this._setScreen(a,this._windowMarkup.find(".ifree-popup-center"))}else{this._setScreen(a,this._windowMarkup)}},_setScreen:function(a,b){a.renderTo(b);a.on("close",IFree.Util.createDelegate(this._onClose,this));a.on("changescreen",IFree.Util.createDelegate(this._onChangeScreen,this))},_onClose:function(){this._windowMarkup.remove();this._destroyMask()},_onChangeScreen:function(b){$(this._windowMarkup.find(".ifree-popup-screen")[0]).remove();var a=IFree.Popup.ScreenFactory.create(b);this._changeScreen(a)},_setWindowPosition:function(){this._setElementPosition(this._windowMarkup,this._position.left,this._position.top)},_setLocation:function(){this._setElementSize(this._windowMarkup,551,470);this._setWindowPosition();var b=this._windowMarkup.find(".ifree-popup-left");IFree.Util.setElementBackgroundImage(b,IFree.Util.getAbsolutePath("popup-background-left"));this._setElementSize(b,21,470);this._setElementPosition(b,0,0);var a=this._windowMarkup.find(".ifree-popup-center");IFree.Util.setElementBackgroundImage(a,IFree.Util.getAbsolutePath("popup-background-center"));this._setElementSize(a,535,470);this._setElementPosition(a,21,0);var c=this._windowMarkup.find(".ifree-popup-right");IFree.Util.setElementBackgroundImage(c,IFree.Util.getAbsolutePath("popup-background-right"));this._setElementSize(c,23,470);this._setElementPosition(c,556,0)},_setWebkitLocation:function(){this._setElementSize(this._windowMarkup,570,445);IFree.Util.setElementBackgroundImage(this._windowMarkup,IFree.Util.getAbsolutePath("popup-background-center-shadowless"));this._setWindowPosition();var a=this._windowMarkup.find(".ifree-popup-center");this._setElementSize(a,570,445);this._setElementPosition(a,0,-10)},_updateMaskLocation:function(){var a=IFree.UniverseLocationController.getSizeAbsolute();IFree.XYHelper.setOffset(this._popupMaskId,0,0);IFree.Util.setSize(this._popupMaskId,a.width,a.height)},setPosition:function(a){this._position=IFree.Util.clone(a);this._setWindowPosition();this._updateMaskLocation()}});IFree.Popup.HoverControllerSingleton=Class.extend({_onMouseDown:function(b,a,c){a.holded=true;IFree.Util.setElementBackgroundImage(a,c);b.preventDefault()},_onMouseUp:function(a,b){if(!a.holded){return}delete a.holded;IFree.Util.setElementBackgroundImage(a,b)},_onHover:function(a,b){if(!a.holded){IFree.Util.setElementBackgroundImage(a,b)}},register:function(b,a){if(IFree.Util.isMobileUser()){return}b.addClass("ifree-clickable-object");var e=IFree.Util.getAbsolutePath(a);var d=IFree.Util.getAbsolutePath(a+"-hover");var c=IFree.Util.getAbsolutePath(a+"-hold");b.hover(IFree.Util.createDelegate(this._onHover,this,[b,d]),IFree.Util.createDelegate(IFree.Util.setElementBackgroundImage,IFree.Util,[b,e]));b.mousedown(IFree.Util.createDelegate(this._onMouseDown,this,[b,c],true));$(window).mouseup(IFree.Util.createDelegate(this._onMouseUp,this,[b,d]))}});IFree.Popup.HoverController=new IFree.Popup.HoverControllerSingleton();IFree.Popup.Screen=IFree.Popup.Component.extend({_screenCls:"ifree-popup-screen",_screenHeaderCls:"ifree-screen-header",_screenHeaderPreviousCls:"ifree-screen-header-previous",_screenHeaderNextCls:"ifree-screen-header-next",_screenHeaderCloseCls:"ifree-screen-header-close",_screenHeaderTitleCls:"ifree-screen-header-title",init:function(a){this._super(a);this._titleText=a.titleText;this.addEvent("changescreen");this.addEvent("close")},_renderTemplate:function(a){var b=this._renderPopupElement(this._screenCls,true);b+=this._renderHeader(a);b+=this._renderContent(a);b+=this._closeElement();return b},_renderHeader:function(a){var b=this._renderPopupElement(this._screenHeaderCls,true);if(a.previousNavigation){b+=this._renderPopupElement(this._screenHeaderPreviousCls)}if(a.nextNavigation){b+=this._renderPopupElement(this._screenHeaderNextCls)}b+=this._renderPopupElement(this._screenHeaderTitleCls);b+=this._renderPopupElement(this._screenHeaderCloseCls);b+=this._closeElement();return b},_renderContent:function(a){return""},_locateItems:function(){this._locateNavigation();this._locateTitle()},_locateTitle:function(){var a=this._locateElement(this._screenHeaderTitleCls,374,17,100,16);this._setFontSize(a,110);a.text(this._titleText)},_locateNavigation:function(){this._locateElement(this._screenHeaderCls,545,14,0,0);this._closeControl=this._locateNavigationElement("popup-close",this._screenHeaderCloseCls,17,17,540,18);if(IFree.Util.elementDefined(this._findChild(this._screenMarkup,this._screenHeaderPreviousCls))){this._prevControl=this._locateNavigationElement("popup-previous",this._screenHeaderPreviousCls,26,21,17,18)}if(IFree.Util.elementDefined(this._findChild(this._screenMarkup,this._screenHeaderNextCls))){this._nextControl=this._locateNavigationElement("popup-next",this._screenHeaderNextCls,26,21,50,18)}},_locateNavigationElement:function(c,f,g,e,b,a){var d=this._locateImageElement(c,f,g,e,b,a);IFree.Popup.HoverController.register(d,c);return d},_initEvents:function(){this._closeControl.click(IFree.Util.createDelegate(this._onCloseClick,this));if(this._prevControl){this._prevControl.click(IFree.Util.createDelegate(this._onPreviousClick,this))}if(this._nextControl){this._nextControl.click(IFree.Util.createDelegate(this._onNextClick,this))}},_onCloseClick:function(){this.fireEvent("close")},_renderElement:function(b,a){var d=["<div class='"].concat(b,["'>"]);var c=IFree.Util.cat(d);if(a){return c}c+="</div>";return c},_renderPopupElement:function(b,a){if(!IFree.Util.isArray(b)){b=[b]}return this._renderElement(b.concat(["ifree-popup-component"]),a)},_closeElement:function(){return"</div>"},_findChild:function(b,a){return b.find(IFree.Util.makeSelector(a))},_locateElement:function(d,e,c,b,a){return this._locateElementOn(this._screenMarkup,d,e,c,b,a)},_locateElementOn:function(f,e,g,d,b,a){var c=this._findChild(f,e);this._setElementSize(c,g,d);this._setElementPosition(c,b,a);return c},_locateImageElementOn:function(g,d,f,h,e,b,a){var c=this._locateElementOn(g,f,h,e,b,a);IFree.Util.setElementBackgroundImage(c,IFree.Util.getAbsolutePath(d));return c},_locateImageElement:function(c,e,f,d,b,a){return this._locateImageElementOn(this._screenMarkup,c,e,f,d,b,a)},_setFontSize:function(b,c){var a=IFree.Environment.screenFontSize(c);IFree.Util.setElementFontSize(b,a)}});IFree.Popup.Screen.Type={SINGLE:"single",GROUP:"group",TRYIT:"tryit",COMINGSOON:"comingsoon"};IFree.Popup.SingleScreen=IFree.Popup.Screen.extend({_textAreaHeight:80,_scrollValue:10,_textAreaWidth:500,_textDownControlHeight:12,_textDownControlWidth:21,_textAreaLeft:40,_textAreaTop:340,_singleScreenContentCls:"ifree-single-screen-content",_singleScreenPolaroidCls:"ifree-single-screen-polaroid",_singleScreenPolaroidPhotoCls:"ifree-single-screen-polaroid-photo",_singleScreenPolaroidTextCls:"ifree-single-screen-polaroid-text",_singleScreenTextCls:"ifree-single-screen-text",_singleScreenTextTopCls:"ifree-textarea-top",_singleScreenTextCenterCls:"ifree-textarea-center",_singleScreenTextBottomCls:"ifree-textarea-bottom",_singleScreenTextAreaCls:"ifree-textarea-text",_singleScreenTextScrollWrapperCls:"ifree-textarea-scroll-wrapper",_popupHideCls:"ifree-popup-hide",_captionTextCls:"ifree-caption-text",init:function(a){this._super(a);this._polaroid=IFree.Popup.PolaroidRegistry.getItem(a.polaroidId);this._parentGroupConfig=a.groupConfig},_renderContent:function(a){var b=this._renderElement(this._singleScreenContentCls,true);b+=this._renderPolaroidArea(a);b+=this._renderTextArea();b+=this._closeElement();return b},_renderPolaroidArea:function(b){var a=[this._singleScreenPolaroidCls];if(b.previousNavigation){a.push("ifree-clickable-object")}var c=this._renderPopupElement(a,true);c+=this._renderPopupElement(this._singleScreenPolaroidPhotoCls);c+=this._renderPopupElement([this._singleScreenPolaroidTextCls,this._captionTextCls]);c+=this._closeElement();return c},_renderTextArea:function(){var a=this._renderPopupElement(this._singleScreenTextCls,true);a+=this._renderPopupElement([this._singleScreenTextTopCls,this._popupHideCls]);a+=this._renderPopupElement(this._singleScreenTextCenterCls,true);a+=this._renderTextScrollWrapper();a+=this._closeElement();a+=this._renderPopupElement([this._singleScreenTextBottomCls,this._popupHideCls]);a+=this._closeElement();return a},_renderTextScrollWrapper:function(){var a=this._renderElement([this._singleScreenTextScrollWrapperCls],true);a+=this._renderElement([this._singleScreenTextAreaCls],true);a+="{{html text}}";a+=this._closeElement();a+=this._closeElement();return a},renderTo:function(a){$.template("single-screen-template",this._renderTemplate({previousNavigation:this._canNavagateBack()}));this._screenMarkup=$.tmpl("single-screen-template",{text:this._getScreenText()});this._screenMarkup.appendTo(a);this._locateItems();this._initEvents();this._showTextControls()},_getScreenText:function(){return this._polaroid.text()},_locateItems:function(){this._super();this._locatePolaroid();this._locateText()},_initEvents:function(){this._super();this._initTextEvents();this._initNavigationEvents()},_initNavigationEvents:function(){if(this._canNavagateBack()){this._polaroidElement.click(IFree.Util.createDelegate(this._onPreviousClick,this))}},_onTextUp:function(){this._scrollText(-this._scrollValue);this._showTextControls()},_scrollText:function(a){this._textAreaScrolling[0].scrollTop+=IFree.Environment.yFromRelativeToScreen(a)},_showTextControls:function(){this._hideElement(this._textUpControl);this._hideElement(this._textDownControl);var a=IFree.Environment.yFromRelativeToScreen(this._textAreaHeight);if(this._textAreaScrolling[0].scrollTop>0){this._showElement(this._textUpControl)}if(this._textAreaScrolling[0].scrollTop<this._textAreaScrolling[0].scrollHeight-a){this._showElement(this._textDownControl)}},_onTextDown:function(a){this._scrollText(this._scrollValue);this._showTextControls()},_onScroll:function(a){this._showTextControls()},_locateText:function(){var b=this._locateElement(this._singleScreenTextCls,this._textAreaWidth,this._textAreaHeight+50,this._textAreaLeft,this._textAreaTop);this._textUpControl=this._locateImageElement("popup-scroll-up",this._singleScreenTextTopCls,this._textDownControlWidth,this._textDownControlHeight,(this._textAreaWidth-this._textDownControlWidth)/2,0);this._textDownControl=this._locateImageElement("popup-scroll-down",this._singleScreenTextBottomCls,this._textDownControlWidth,this._textDownControlHeight,(this._textAreaWidth-this._textDownControlWidth)/2,this._textAreaHeight+20);var a=this._locateElement(this._singleScreenTextCenterCls,this._textAreaWidth,this._textAreaHeight,0,15);this._textAreaScrolling=this._locateElement(this._singleScreenTextScrollWrapperCls,this._textAreaWidth+100,this._textAreaHeight,0,0);this._textAreaContent=this._findChild(this._screenMarkup,this._singleScreenTextAreaCls);this._setFontSize(this._textAreaContent,100);this._setElementWidth(this._textAreaContent,this._textAreaWidth-10)},_initTextEvents:function(){this._textDownControl.click(IFree.Util.createDelegate(this._onTextDown,this));this._textUpControl.click(IFree.Util.createDelegate(this._onTextUp,this));if(IFree.Util.isIE()){this._textDownControl.dblclick(IFree.Util.createDelegate(this._onTextDown,this));this._textUpControl.dblclick(IFree.Util.createDelegate(this._onTextUp,this))}IFree.Popup.HoverController.register(this._textUpControl,"popup-scroll-up");IFree.Popup.HoverController.register(this._textDownControl,"popup-scroll-down");this._textAreaScrolling.scroll(IFree.Util.createDelegate(this._onScroll,this))},_locatePolaroid:function(){this._polaroidElement=this._locateImageElement("polaroid-big-background",this._singleScreenPolaroidCls,271,311,150,27);var a=this._locateImageElement(this._polaroid.getBigPhotoId(),this._singleScreenPolaroidPhotoCls,220,210,27,29);var b=this._locateElement(this._singleScreenPolaroidTextCls,220,50,27,250);this._setFontSize(b,this._polaroid.bigFontSize());b.text(this._polaroid.caption())},_showElement:function(a){a.removeClass(this._popupHideCls)},_hideElement:function(a){a.addClass(this._popupHideCls)},_onPreviousClick:function(){this.fireEvent("changescreen",this._parentGroupConfig)},_canNavagateBack:function(){return this._parentGroupConfig}});IFree.Popup.PolaroidAllocator=Class.extend({_layouts:[[],[1],[2],[3],[[2],[2]],[[3],[2]],[[3],[3]]],_polaroidXSpace:4,_polaroidYSpace:4,_centerXCoef:0.5,_centerYCoef:0.25,_polaroidRowTemplate:"<div class='ifree-polaroid-row ifree-popup-component'></div>",_polaroidContainerTemplate:"<div class='ifree-polaroid-container ifree-popup-component'></div>",init:function(a){this._layout=this._layouts[a.polaroidCount];$.template("polaroid-container-template",this._polaroidContainerTemplate);$.template("polaroid-row-template",this._polaroidRowTemplate);this._polaroidWidth=a.polaroidWidth;this._polaroidHeight=a.polaroidHeight;this._areaElement=a.area;this._currentRow=0;this._currentColumn=0;this._currentXOffset=0;this._currentYOffset=0;this._rows=[];this._row=this._createRow();this._container=this._renderMarkup("polaroid-container-template");this._container.appendTo(this._areaElement);this._appendRow(this._row)},_appendRow:function(a){this._rows.push(a);this._currentYOffset+=this._polaroidYSpace;a.appendTo(this._container);this._locateElement(a,0,this._currentYOffset);this._currentYOffset+=this._polaroidHeight+this._polaroidYSpace},_createRow:function(){return this._renderMarkup("polaroid-row-template")},_renderMarkup:function(a){return $.tmpl(a)},_centerHorizontally:function(c){var a=this._currentXOffset;var b=(this._relX(this._areaElement.width())-a)*this._centerXCoef;this._locateElement(c,b,this._relY(c.position().top))},_centerVertically:function(a){var c=this._currentYOffset;var b=(this._relY(this._areaElement.height())-c)*this._centerYCoef;IFree.Util.foreach(a,function(d){b+=this._polaroidYSpace;this._locateElement(d,this._relX(d.position().left),b);b+=this._polaroidHeight+this._polaroidYSpace},this)},_locateElement:function(a,c,b){IFree.XYHelper.setElementPosition(a,c,b)},_relX:function(a){return IFree.Environment.xFromScreenToRelative(a)},_relY:function(a){return IFree.Environment.yFromScreenToRelative(a)},_appendPolaroid:function(b,a){this._currentXOffset+=this._polaroidXSpace;a.appendTo(b);this._locateElement(a,this._currentXOffset,0);this._currentXOffset+=this._polaroidWidth+this._polaroidXSpace},allocateNext:function(a){this._appendPolaroid(this._row,a);if(this._currentColumn==this._layout[this._currentRow]-1){this._centerHorizontally(this._row);this._centerVertically(this._rows);this._currentColumn=0;this._currentRow++;this._currentXOffset=0;if(this._currentRow<this._layout.length){this._row=this._createRow();this._appendRow(this._row)}}else{this._currentColumn++}}});IFree.Popup.GroupScreen=IFree.Popup.Screen.extend({_polaroidTemplate:"<div class='ifree-group-screen ifree-small-polaroid ifree-clickable-object'><div class='ifree-group-screen-polaroid-photo ifree-popup-component'></div><div class='ifree-group-screen-polaroid-text ifree-popup-component ifree-caption-text'></div></div>",_polaroidWidth:175,_polaroidHeight:201,_groupScreenContentCls:"ifree-group-screen-content",init:function(a){this._super(a);this._currentConfig=a;this._groupIds=a.groupIds;this._currentIndex=a.currentIndex||0;this._groupId=this._groupIds[this._currentIndex];this._polaroidIds=IFree.Popup.PolaroidGroupRegistry.getItem(this._groupId).items()},renderTo:function(a){$.template("group-screen-template",this._renderTemplate({previousNavigation:this._currentIndex>0,nextNavigation:this._currentIndex<this._groupIds.length-1}));this._screenMarkup=$.tmpl("group-screen-template");this._screenMarkup.appendTo(a);this._renderPolaroids();this._locateItems();this._initEvents()},_renderContent:function(){var a=this._renderPopupElement(this._groupScreenContentCls);return a},_renderPolaroid:function(c,b,f){$.template("small-polaroid-template",this._polaroidTemplate);var e=$.tmpl("small-polaroid-template");IFree.Util.setElementBackgroundImage(e,IFree.Util.getAbsolutePath("polaroid-small-background"));this._setElementSize(e,this._polaroidWidth,this._polaroidHeight);var d=IFree.Popup.PolaroidRegistry.getItem(c);var a=this._locateImageElementOn(e,d.getSmallPhotoId(),"ifree-group-screen-polaroid-photo",140,130,18,17);var g=this._locateElementOn(e,"ifree-group-screen-polaroid-text",140,34,18,154);g.text(d.caption());this._setFontSize(g,d.smallFontSize());this._polaroidAllocator.allocateNext(e)},_renderPolaroids:function(){var a=this._locateElement(this._groupScreenContentCls,538,400,16,40);this._polaroidAllocator=new IFree.Popup.PolaroidAllocator({polaroidWidth:this._polaroidWidth,polaroidHeight:this._polaroidHeight,area:a,polaroidCount:this._polaroidIds.length});IFree.Util.foreach(this._polaroidIds,function(b,c){this._renderPolaroid(b,c,a)},this)},_onPolaroidClick:function(a){var c=IFree.Popup.PolaroidRegistry.getItem(this._polaroidIds[a]);var b={polaroidId:c.id(),groupConfig:IFree.Util.clone(this._currentConfig),type:c.screenType()};this.fireEvent("changescreen",b)},_fireChangeScreen:function(a){var b=IFree.Util.clone(this._currentConfig);b.currentIndex=a;this.fireEvent("changescreen",b)},_onPreviousClick:function(){this._fireChangeScreen(this._currentIndex-1)},_onNextClick:function(){this._fireChangeScreen(this._currentIndex+1)},_initEvents:function(){IFree.Util.foreach(this._polaroidIds,function(a,b){$(this._screenMarkup.find(".ifree-small-polaroid")[b]).click(IFree.Util.createDelegate(this._onPolaroidClick,this,[b]))},this);this._super()}});IFree.Popup.TryItScreen=IFree.Popup.SingleScreen.extend({_textAreaTop:375,_textAreaHeight:45,_tryItButtonCls:"ifree-tryit-screen-button",_clickableCls:"ifree-clickable-object",init:function(a){this._super(a);this._downloadUri=IFree.Popup.PolaroidRegistry.getItem(a.polaroidId).downloadUri()},_renderTextArea:function(){var a=this._renderPopupElement([this._tryItButtonCls,this._clickableCls]);a+=this._super();return a},_locateItems:function(){this._super();this._locateButton()},_locateButton:function(){this._downloadButton=this._findChild(this._screenMarkup,this._tryItButtonCls);IFree.Util.setElementBackgroundImage(this._downloadButton,IFree.Util.getAbsolutePath("popup-tryit"));this._setElementSize(this._downloadButton,101,27);this._setElementPosition(this._downloadButton,235,345)},_onDownloadButtonClick:function(){IFree.Util.goToLink(this._downloadUri)},_initEvents:function(){this._super();this._downloadButton.click(IFree.Util.createDelegate(this._onDownloadButtonClick,this))}});IFree.Popup.ComingSoonScreen=IFree.Popup.SingleScreen.extend({_textAreaHeight:40,_textAreaWidth:250,_textAreaLeft:190,_locateText:function(){this._super();this._setFontSize(this._textAreaContent,130);this._textAreaContent.addClass("ifree-coming-soon-text")},_getScreenText:function(){return"The product is coming"}});IFree.Popup.Polaroid=Class.extend({_photoPrefix:"photo",_textPrefix:"text",_bigPrefix:"big",_smallPrefix:"small",_polaroidPrefix:"polaroid",_defaultBigFontSize:150,_defaultSmallFontSize:100,init:function(a){this._id=a.id;this._text=a.text||"";this._caption=a.caption;this._bigFontSize=a.bigFontSize||this._defaultBigFontSize;this._smallFontSize=a.smallFontSize||this._defaultSmallFontSize;this._singleScreenType=a.singleScreenType;this._downloadUri=a.downloadUri||""},id:function(){return this._id},screenType:function(){return this._singleScreenType},downloadUri:function(){return this._downloadUri},text:function(){return this._text},getBigPhotoId:function(){return this._polaroidPrefix+"-"+this._id+"-"+this._bigPrefix+"-"+this._photoPrefix},getSmallPhotoId:function(){return this._polaroidPrefix+"-"+this._id+"-"+this._smallPrefix+"-"+this._photoPrefix},caption:function(){return this._caption},bigFontSize:function(){return this._bigFontSize},smallFontSize:function(){return this._smallFontSize}});IFree.Popup.PolaroidRegistry=new IFree.ItemRegistrySingleton({itemsUrl:"resources/polaroids.json",itemConstructors:{polaroid:IFree.Popup.Polaroid},defaultProperties:{type:"polaroid"}});IFree.Popup.PolaroidGroup=Class.extend({init:function(a){this._id=a.id;this._items=a.items.slice(0)},id:function(){return this._id},items:function(){return this._items},itemAt:function(a){return this._items[a]}});IFree.Popup.PolaroidGroupRegistry=new IFree.ItemRegistrySingleton({itemsUrl:"resources/polaroidgroups.json",itemConstructors:{polaroidgroup:IFree.Popup.PolaroidGroup},defaultProperties:{type:"polaroidgroup"}});IFree.Popup.ScreenFactory=new IFree.ObjectFactory({objectConstructors:{single:IFree.Popup.SingleScreen,group:IFree.Popup.GroupScreen,tryit:IFree.Popup.TryItScreen,comingsoon:IFree.Popup.ComingSoonScreen}});IFree.Popup.ClickableObject=Class.extend({init:function(a){this._initialConfig=IFree.Util.clone(a);IFree.Util.onClick(a.objectId,IFree.Util.createDelegate(function(){var b=new IFree.Popup.Window({position:this._getPopupWindowPosition()});b.showScreen(IFree.Popup.ScreenFactory.create(a.screenConfig));IFree.Util.onWindowResize(IFree.Util.createDelegate(function(){b.setPosition(this._getPopupWindowPosition())},this))},this));if(IFree.Util.isMobileUser()){return}IFree.Util.getElement(a.objectId).hover(function(){var c=IFree.XYHelper.getOffset(a.objectId);var b=IFree.ObjectRegistry.getItem(a.objectId);IFree.ClickMePopup.showAt(c.left,c.top,b.width(),b.height(),a.targetSide,a.offsetLeft,a.offsetTop)},function(){IFree.ClickMePopup.hide()}).addClass("ifree-clickable-object")},_getPopupWindowPosition:function(){var a=IFree.ObjectRegistry.getItem("ifree-solar-system").coordinates();return{left:a[0]+130,top:a[1]+224}},config:function(){return this._initialConfig},objectId:function(){return this._initialConfig.objectId}});IFree.Popup.ClickableObjectRegistry=new IFree.ItemRegistrySingleton({itemsUrl:"resources/clickableobjects.json",itemConstructors:{clickableobject:IFree.Popup.ClickableObject},defaultProperties:{type:"clickableobject"}});IFree.LoadController=(function(){function c(){if(IFree.Util.isIE()){var d=IFree.ImageRegistry.getItem("world-train");d._path=d._path+"-ie"}}function b(){if(IFree.Util.isIE()||IFree.Util.isOpera()){var e=IFree.Util.getElement("ifree-lines");e.detach();var d=IFree.Util.getElement("ifree-earth");d.after(e)}}function a(){IFree.Util.getElement("ifree-body").removeClass("ifree-hidden")}return{load:function(){var d=new IFree.Task();d.call(IFree.ScreenResolutionRegistry,"loadItems").fire("resolutions");d.call(IFree.Environment,"chooseAppropriateScale").after("resolutions");d.call(IFree.ImageRegistry,"loadItems").after("resolutions").fire("imageItems");d.call(c).after("imageItems");d.call(IFree.ImageLoadController,"loadImageGroup",["first"]).after("imageItems").fire("firstGroupImages");d.call(IFree.ImageLoadController,"loadAnimationFirstFrames").after("imageItems").fire("animationFirstImages");d.call(IFree.ObjectRegistry,"loadItems").after("imageItems","firstGroupImages","animationFirstImages").fire("objectItems");d.call(b).after("objectItems");d.call(IFree.TrainController,"createClickElement").fire("train");d.call(IFree.AnimationController,"start").after("objectItems");d.call(IFree.UniverseLocationController,"adjustLocation").after("objectItems").fire("adjustLocation");d.call(a).after("adjustLocation");d.call(IFree.ImageLoadController,"loadStationInputs").after("objectItems").fire("stationInputs");d.call(IFree.TrainController,"start").after("objectItems","stationInputs");d.call(IFree.ImageLoadController,"loadImageGroup",["popup"]).after("imageItems").fire("popupImages");d.call(IFree.FontLoader,"load").after("objectItems").fire("webfonts");d.call(IFree.Popup.PolaroidRegistry,"loadItems").after("objectItems").fire("polaroids");d.call(IFree.Popup.PolaroidGroupRegistry,"loadItems").after("objectItems").fire("polaroidGroups");d.call(IFree.Popup.ClickableObjectRegistry,"loadItems").after("polaroids","polaroidGroups","popupImages","webfonts","train").fire("clickableObjects");if(IFree.Util.isMobileUser()){d.call(IFree.ClickMeController,"start").after("clickableObjects")}d.start()}}}());